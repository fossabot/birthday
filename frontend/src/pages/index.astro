---
import BaseLayout from '~layouts/BaseLayout.astro'
import BirthdayContent from '~components/BirthdayContent.vue'
import BirthdaySelect from '~components/BirthdaySelect.vue'
import SubscribtionButton from '~components/SubscribtionButton.vue'

import { getTimeZones } from '@vvo/tzdb'
import { fetchBirthdayNotificationServer } from '~utils/backend'

const birthdayData: BackendListResponse[] =
  await fetchBirthdayNotificationServer('list').then((response) =>
    response.json()
  )
const timeZones = getTimeZones({ includeUtc: false }).sort(
  ({ name: a }, { name: b }) => a.localeCompare(b)
)
const data = Buffer.from(
  JSON.stringify({ data: birthdayData, timeZones })
).toString('base64')
---

<BaseLayout>
  <birthday-container data-value={data}>
    <BirthdaySelect client:only />
    <BirthdayContent client:only />
    <SubscribtionButton client:only />
  </birthday-container>
</BaseLayout>

<script>
  import { BirthdayContainerData, data, timeZones } from '~stores/data'

  class BirthdayContainer extends HTMLElement {
    constructor() {
      super()

      const v: BirthdayContainerData = JSON.parse(atob(this.dataset.value!))

      data.set(v.data)
      timeZones.set(v.timeZones)
      this.removeAttribute('data-value')
    }
  }

  customElements.define('birthday-container', BirthdayContainer)
</script>

<style>
  birthday-container {
    display: flex;
    width: 100%;
    flex-direction: column;
    justify-content: center;
    align-items: center;
  }
</style>
